<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script>
        
        const server = 'https://<API-ID>.execute-api.us-east-1.amazonaws.com/prod'; // Replace with your API ID
        const login_server = 'https://<COGNITO-DOMAIN>.auth.us-east-1.amazoncognito.com/login?client_id=<CLIENT-ID>&response_type=token&scope=aws.cognito.signin.user.admin+email+openid+phone+profile&redirect_uri=https://<CLOUDFRONT-DOMAIN>/index.html';

        function handleAuth() {
            if (localStorage.getItem('bearer_str')) {
                localStorage.removeItem('bearer_str');
                updateAuthButton();
                alert('Logged out successfully');
                window.location.reload();
            } else {
                window.location.href = login_server;
            }
        }

        function updateAuthButton() {
            const authButton = document.getElementById('authButton');
            if (localStorage.getItem('bearer_str')) {
                authButton.innerText = "Logout";
            } else {
                authButton.innerText = "Login";
            }
        }

        async function fetchProductData() {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to view products.');
                return;
            }

            try {
                const response = await fetch(`${server}/products/get_all_products`, {
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const responseData = await response.json();
                const data = JSON.parse(responseData.body);

                const listElement = document.getElementById('product-list');
                listElement.innerHTML = '';

                if (Array.isArray(data)) {
                    data.forEach(product => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            Product: ${product.ProductName}, Price: ${product.ProductPrice}, Owner: ${product.ProductOwner} 
                            <button onclick="deleteProduct('${product.ProductName}', '${product.ProductPrice}', '${product.ProductOwner}')">Delete</button>
                            <button onclick="buyProduct('${product.ProductName}', '${product.ProductPrice}')">Buy</button>`;
                        listElement.appendChild(listItem);
                    });
                } else {
                    console.error('Data is not an array:', data);
                }
            } catch (error) {
                console.error('Error fetching product data:', error);
            }
        }

        async function addProduct() {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) return alert('You must be logged in to add a product.');
            const productName = document.getElementById('product-name').value.trim();
            const productPrice = document.getElementById('product-price').value.trim();
            if (!productName || !productPrice) return alert('Please fill in both fields.');

            try {
                const base64Url = bearerToken.split('.')[1];
                const payload = JSON.parse(atob(base64Url));
                const username = payload['username'] || payload['cognito:username'];

                await fetch(`${server}/products`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ product_name: productName, product_price: productPrice, product_owner: username })
                });

                alert('Product added successfully!');
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
                fetchProductData();
            } catch (error) {
                console.error('Error adding product:', error);
            }
        }

        async function deleteProduct(productName, productPrice, productOwner) {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to delete products.');
                return;
            }

            try {
                // Decode the JWT token to get the current user
                const base64Url = bearerToken.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(atob(base64));

                const currentUser = payload['username'] || payload['cognito:username'];

                if (!currentUser) {
                    alert('Failed to retrieve current user.');
                    return;
                }

                // Check if the logged-in user is the owner of the product
                if (productOwner !== currentUser) {
                    alert('Unauthorized to delete this product.');
                    return;
                }
                
                // Prepare the request body
                const requestBody = {
                    product_name: productName,   // Correct key format
                    product_price: productPrice, // Correct key format
                    product_owner: productOwner  // Correct key format
                };

                // Log the request body for debugging
                console.log('Request Body:', requestBody);

                const response = await fetch(`${server}/products`, {
                    method: 'DELETE', // DELETE method
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // Attach the request body
                });

                // Parse the response
                const responseData = await response.json();
                console.log('Delete Product Response:', responseData); // Debugging step

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                alert('Product deleted successfully!');
                fetchProductData();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }

        async function buyProduct(productName, productPrice) {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to buy products.');
                return;
            }

            // Confirm purchase
            const isConfirmed = confirm(`Are you sure you want to purchase "${productName}" for $${productPrice}? EW CRINGE!`);
            if (!isConfirmed) {
                return;
            }

            try {
                // Decode JWT to extract the user's email
                const base64Url = bearerToken.split('.')[1]; // Extract payload from JWT
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // URL-safe to Base64
                const payload = JSON.parse(atob(base64)); // Decode the Base64 string

                // Log the decoded payload to ensure the email exists
                console.log('Decoded Payload:', payload);

                const userEmail = payload['email']; // Get the email from the token payload

                if (!userEmail) {
                    console.error('Email not found in token payload.');
                    alert('Failed to retrieve email from token. Ensure you are logged in.');
                    return;
                }

                // Prepare request body
                const requestBody = {
                    product_name: productName,
                    product_price: productPrice,
                    user_email: userEmail
                };

                console.log('Request Body:', requestBody); // Log the request body

                // Make API call to initiate the purchase
                const response = await fetch(`${server}/products/purchase`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
    
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                alert(`Purchase confirmed! A receipt has been sent to ${userEmail}.`);
            } catch (error) {
                console.error('Error processing purchase:', error);
                alert('Failed to complete the purchase. Please try again.');
            }
        }

        window.onload = function () {
            updateAuthButton();
            fetchProductData();
        };
    </script>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <h1>Marketplace</h1>
        <button id="authButton" class="auth-button" onclick="handleAuth()">Login</button>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h2>Products</h2>
        <ul id="product-list" class="product-section">LOG IN TO VIEW PRODUCTS</ul>
        <div class="add-product">
            <h3>Add a New Product</h3>
            <input type="text" id="product-name" placeholder="Product Name" />
            <input type="number" id="product-price" placeholder="Product Price" />
            <button class="auth-button" onclick="addProduct()">Add Product</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        &copy; 2024 Marketplace. All rights reserved.
    </footer>
</body>
</html>
