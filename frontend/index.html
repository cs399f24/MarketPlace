<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace</title>
    <link rel="stylesheet" href="style.css">
    <script>
        const server = 'https://hdrq77dp7h.execute-api.us-east-1.amazonaws.com/prod';
        const login_server = 'https://ss-2024-11-21.auth.us-east-1.amazoncognito.com/login?client_id=51h77vn3rse7n58bum9c8dd4bu&response_type=token&scope=email+openid&redirect_uri=https%3A%2F%2Fstaging.d3c6e5p4ore4dg.amplifyapp.com%2Fcallback.html';

        function handleAuth() {
            if (localStorage.getItem('bearer_str')) {
                localStorage.removeItem('bearer_str');
                updateAuthButton();
                alert('Logged out successfully');
                window.location.reload();
            } else {
                window.location.href = login_server;
            }
        }

        function updateAuthButton() {
            const authButton = document.getElementById('authButton');
            if (localStorage.getItem('bearer_str')) {
                authButton.innerText = "Logout";
            } else {
                authButton.innerText = "Login";
            }
        }

        async function fetchProductData() {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to view products.');
                return;
            }

            try {
                const response = await fetch(`${server}/products/get_all_products`, {
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const responseData = await response.json();
                const data = JSON.parse(responseData.body);

                const listElement = document.getElementById('product-list');
                listElement.innerHTML = '';

                if (Array.isArray(data)) {
                    data.forEach(product => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `Product: ${product.ProductName}, Price: ${product.ProductPrice}, Owner: ${product.ProductOwner} 
                            <button onclick="deleteProduct('${product.ProductName}', '${product.ProductPrice}', '${product.ProductOwner}')">Delete</button>`;
                        listElement.appendChild(listItem);
                    });
                } else {
                    console.error('Data is not an array:', data);
                }
            } catch (error) {
                console.error('Error fetching product data:', error);
            }
        }

        async function addProduct() {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to add a product.');
                return;
            }

            const productName = document.getElementById('product-name').value.trim();
            const productPrice = document.getElementById('product-price').value.trim();

            if (!productName || !productPrice) {
                alert('Please provide both product name and price.');
                return;
            }

            try {
                // Decode JWT to extract the username
                const base64Url = bearerToken.split('.')[1]; // Extract payload from JWT
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // URL-safe to Base64
                const payload = JSON.parse(atob(base64)); // Decode the Base64 string
                console.log('Decoded Payload:', payload); // Debugging step

                const username = payload['username'] || payload['cognito:username']; // Adjust key as needed
                if (!username) {
                    alert('Failed to retrieve username from token. Ensure you are logged in.');
                    return;
                }

                // Log username for debugging
                console.log('Username:', username);

                // Make API call to add the product
                const requestBody = {
                    product_name: productName,   // Correct key format
                    product_price: productPrice, // Correct key format
                    product_owner: username      // Correct key format
                };

                // Log request body for debugging
                console.log('Request Body:', requestBody);

                const response = await fetch(`${server}/products`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseData = await response.json();
                console.log('Add Product Response:', responseData); // Debugging step

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                alert('Product added successfully!');

                // Clear input fields
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
    
                // Refresh product list
                fetchProductData();
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Failed to add product. Please try again.');
            }
        }

        async function deleteProduct(productName, productPrice, productOwner) {
            const bearerToken = localStorage.getItem('bearer_str');
            if (!bearerToken) {
                alert('You must be logged in to delete products.');
                return;
            }

            try {
                // Decode the JWT token to get the current user
                const base64Url = bearerToken.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(atob(base64));

                const currentUser = payload['username'] || payload['cognito:username'];

                if (!currentUser) {
                    alert('Failed to retrieve current user.');
                    return;
                }

                // Check if the logged-in user is the owner of the product
                if (productOwner !== currentUser) {
                    alert('Unauthorized to delete this product.');
                    return;
                }
                
                // Prepare the request body
                const requestBody = {
                    product_name: productName,   // Correct key format
                    product_price: productPrice, // Correct key format
                    product_owner: productOwner  // Correct key format
                };

                // Log the request body for debugging
                console.log('Request Body:', requestBody);

                const response = await fetch(`${server}/products`, {
                    method: 'DELETE', // DELETE method
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // Attach the request body
                });

                // Parse the response
                const responseData = await response.json();
                console.log('Delete Product Response:', responseData); // Debugging step

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                alert('Product deleted successfully!');
                fetchProductData();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }

        window.onload = function() {
            updateAuthButton();
            fetchProductData();
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>Welcome to the Marketplace!</h1>
        <button id="authButton" class="auth-button" onclick="handleAuth()">Login</button>
        <div id="product" class="product-section">
            <h2>Products</h2>
            <ul id="product-list">LOG IN TO VIEW PRODUCTS</ul>
            <h3>Add a New Product</h3>
            <input type="text" id="product-name" placeholder="Product Name" />
            <input type="number" id="product-price" placeholder="Product Price" />
            <button onclick="addProduct()">Add Product</button>
        </div>
    </div>
</body>
</html>
